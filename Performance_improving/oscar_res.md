# OSCAR JPEG 복원 결과 분석

이 문서에서는 **OSCAR**를 사용한 JPEG 압축 이미지 복원 실험 결과를 정리합니다.  
실험에서는 JPEG10, JPEG50, JPEG70 등 서로 다른 압축률 이미지를 대상으로, 다양한 **range 파라미터**를 적용해 PSNR, SSIM, LPIPS 지표를 측정했습니다.

## 1. 실험 환경
- **모델**: OSCAR (Stable Diffusion 기반)
- **평가 지표**
  - PSNR: Peak Signal-to-Noise Ratio (높을수록 원본에 가까움)
  - SSIM: Structural Similarity Index (1에 가까울수록 원본과 구조 유사)
  - LPIPS: Learned Perceptual Image Patch Similarity (낮을수록 원본과 시각적 유사)

---

## 2. 전체 결과

### JPEG 10

- **Before:** PSNR 22.6170, SSIM 0.6948, LPIPS 0.3334  

| Range  | PSNR    | SSIM   | LPIPS  |
|--------|--------|--------|--------|
| 0.0019 | 12.7350 | 0.1733 | 0.7877 |
| 0.0098 | 14.7728 | 0.2089 | 0.6752 |
| 0.0313 | 16.1434 | 0.2659 | 0.4366 |
| 0.0430 | 16.8798 | 0.2878 | 0.4098 |
| 0.0625 | 16.9815 | 0.3412 | 0.3943 |
| 0.0781 | 17.7341 | 0.3765 | 0.3488 |
| 0.0937 | 18.3665 | 0.3925 | 0.3355 |
| 0.1250 | 18.8658 | 0.4203 | 0.3138 |

**Best Range:** 0.125 → PSNR 18.8658 / SSIM 0.4203 / LPIPS 0.3138

---

### JPEG 50

- **Before:** PSNR 26.9773, SSIM 0.8770, LPIPS 0.0707  

| Range  | PSNR    | SSIM   | LPIPS  |
|--------|--------|--------|--------|
| 0.0019 | 12.4422 | 0.1734 | 0.7737 |
| 0.0098 | 14.4597 | 0.2088 | 0.6258 |
| 0.0313 | 15.9011 | 0.2600 | 0.3726 |
| 0.0430 | 16.6446 | 0.2803 | 0.3356 |
| 0.0625 | 16.9628 | 0.3356 | 0.2888 |
| 0.0781 | 17.3698 | 0.3724 | 0.2648 |
| 0.0937 | 18.1387 | 0.3874 | 0.2331 |
| 0.1250 | 18.6823 | 0.4193 | 0.2084 |

**Best Range:** 0.125 → PSNR 18.6823 / SSIM 0.4193 / LPIPS 0.2084

---

### JPEG 70

- **Before:** PSNR 28.7367, SSIM 0.9141, LPIPS 0.0374  

| Range  | PSNR    | SSIM   | LPIPS  |
|--------|--------|--------|--------|
| 0.0019 | 12.4481 | 0.1679 | 0.7723 |
| 0.0098 | 14.4309 | 0.2059 | 0.6181 |
| 0.0313 | 15.8659 | 0.2567 | 0.3686 |
| 0.0430 | 16.6121 | 0.2773 | 0.3351 |
| 0.0625 | 16.9352 | 0.3332 | 0.2885 |
| 0.0781 | 17.3034 | 0.3686 | 0.2619 |
| 0.0937 | 18.0706 | 0.3842 | 0.2335 |
| 0.1250 | 18.5709 | 0.4162 | 0.2076 |

**Best Range:** 0.125 → PSNR 18.5709 / SSIM 0.4162 / LPIPS 0.2076

---

## 3. 분석 요약
1. **PSNR**: range가 증가할수록 개선되나 denoising 효과 x 
2. **SSIM**: range가 증가할수록 개선되나 denoising 효과 x 
3. **LPIPS**: range 증가할수록 개선되며 JPEG10에서만 효과를 보임
4. **종합**: 최적 range는 모두 0.125 수준, range를 더 높여서 실험해볼 것

---

## 3. Range의 의미 및 후보 선택

### 3.1 Range가 의미하는 것
- OSCAR는 latent 기반 확산 모델로, 압축된 이미지를 복원할 때 latent의 노이즈 수준을 조절합니다.  
- `range`는 latent의 distortion 또는 pseudo-noise 레벨을 의미하며, 값이 클수록 **강한 보정/재생성**을 수행합니다.

### 3.2 여러 후보를 사용하는 이유
- 압축 손상 정도가 이미지마다 다르므로, 하나의 고정된 range만 사용하면 일부 이미지는 과소 복원, 일부는 과도 복원이 발생할 수 있음  
- 여러 range 후보를 미리 계산 후 최적 값 선택 → 멀티 손상 레벨 대응  
- 일반적으로 6~10개 후보는 **계산 효율과 탐색 범위**의 균형을 고려한 값

---

## 4. Range 확장 실험 제안

| 범위 | 기대 효과 / 위험 |
|------|----------------|
| 더 큰 range (0.15, 0.2, 0.25, 0.3 …) | PSNR/SSIM/LPIPS 개선 가능성, 특히 손상 심한 이미지(JPEG10 등)에서 효과적 |
| 과도한 range | latent를 원본에서 너무 멀리 이동 → 구조 왜곡, 컬러 변화, artifact 발생 가능 |

> 참고 연구:  
> - **Noise scheduling의 중요성**: `On the Importance of Noise Scheduling for Diffusion Models`  
> - **Diffusion 기반 압축-복원 tradeoff**: `Diffusion-based Compression Quality Tradeoffs without Retraining`  
> → decoding hyper-parameter만 조정하여 PSNR과 perceptual 품질 간 trade-off 가능

---

## 5. 추가적인 원인 분석

- OSCAR는 내부 구조 상 **width와 height가 128의 배수**인 이미지만 처리 가능  
- 따라서 실제 입력 이미지가 128 배수가 아닐 경우, 모델은 자동으로 **center crop 또는 resize**를 수행하게 됨
- 이 과정에서 원본 비율과 픽셀 구조가 변하면서 PSNR, SSIM, LPIPS 등 **정량 지표가 저하**될 수 있음
- 해당 실험에서도 flowers 해상도 618x414 -> oscar가 강제 resize (512x512) -> 정량평가 시 gt를 512x512로 resize하여 계산. 해당과정에서 이미지가 약간 왜곡되거나 잘림 → 품질 하락 가능성
- **해결 방안 후보**
  1. **원본 비율 유지 + padding**: 128의 배수로 맞추되, 이미지 내용 손상 없이 주변에 0 또는 평균값 패딩
  2. **Crop 후 입력**: 이미지 비율을 강제로 맞춘 후 모델 입력, 이후 복원 결과를 다시 원본 크기로 resize
- 이러한 접근을 통해, 후처리 없이도 **정량 지표 손실을 최소화**하면서 OSCAR를 적용할 수 있는지 확인 가능

---

## 6. 향후 실험 및 문서 방향

1. 기존 8개 후보 range에 더해 **0.15, 0.20, 0.25 …** 등 추가 or 입력 데이터셋에 padding 후 재실험
2. PSNR, SSIM, LPIPS 지표 + 시각적 샘플 기록  
3. 결과를 그래프로 시각화 (`range vs PSNR/LPIPS/SSIM`)  
4. qualitative 평가 + quantitative 평가 병행  
5. 최종적으로 “데이터별 최적 range 추천 값” 정리

---

### 7. 참고
- CSV 파일: `oscar_metrics_all_ranges.csv`  
- 각 row는 JPEG, range, before/after 지표, best 여부를 포함
